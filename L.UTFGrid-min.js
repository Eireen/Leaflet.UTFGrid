function corslite(t,e,i){function n(t){return t>=200&&t<300||304===t}function o(){void 0===a.status||n(a.status)?e.call(a,null,a):e.call(a,a,null)}var s=!1;if("undefined"==typeof window.XMLHttpRequest)return e(Error("Browser not supported"));if("undefined"==typeof i){var l=t.match(/^\s*https?:\/\/[^\/]*/);i=l&&l[0]!==location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")}var a=new window.XMLHttpRequest;if(i&&!("withCredentials"in a)){a=new window.XDomainRequest;var r=e;e=function(){if(s)r.apply(this,arguments);else{var t=this,e=arguments;setTimeout(function(){r.apply(t,e)},0)}}}return"onload"in a?a.onload=o:a.onreadystatechange=function(){4===a.readyState&&o()},a.onerror=function(t){e.call(this,t||!0,null),e=function(){}},a.onprogress=function(){},a.ontimeout=function(t){e.call(this,t,null),e=function(){}},a.onabort=function(t){e.call(this,t,null),e=function(){}},a.open("GET",t,!0),a.send(null),s=!0,a}"undefined"!=typeof module&&(module.exports=corslite),L.UTFGrid=L.TileLayer.extend({options:{resolution:4,pointerCursor:!0,mouseInterval:66},_mouseOn:null,_mouseOnTile:null,_tileCharCode:null,_cache:null,_idIndex:null,_throttleMove:null,_updateCursor:function(){},onAdd:function(t){this._cache={},this._idIndex={},L.TileLayer.prototype.onAdd.call(this,t),this._throttleMove=L.Util.throttle(this._move,this.options.mouseInterval,this),this.options.pointerCursor&&(this._updateCursor=function(t){this._container.style.cursor=t}),t.on("boxzoomstart",this._disconnectMapEventHandlers,this),t.on("boxzoomend",this._throttleConnectEventHandlers,this),this._connectMapEventHandlers()},onRemove:function(){var t=this._map;t.off("boxzoomstart",this._disconnectMapEventHandlers,this),t.off("boxzoomend",this._throttleConnectEventHandlers,this),this._disconnectMapEventHandlers(),this._updateCursor(""),L.TileLayer.prototype.onRemove.call(this,t)},createTile:function(t){return this._loadTile(t),document.createElement("div")},_connectMapEventHandlers:function(){this._map.on("click",this._onClick,this),this._map.on("mousemove",this._throttleMove,this)},_disconnectMapEventHandlers:function(){this._map.off("click",this._onClick,this),this._map.off("mousemove",this._throttleMove,this)},_throttleConnectEventHandlers:function(){setTimeout(this._connectMapEventHandlers.bind(this),100)},_update:function(t,e){L.TileLayer.prototype._update.call(this,t,e)},_loadTile:function(t){var e=this.getTileUrl(t),i=this._tileCoordsToKey(t),n=this;this._cache[i]||corslite(e,function(t,e){if(t)return void n.fire("error",{error:t});var o=JSON.parse(e.responseText);n._cache[i]=o,L.Util.bind(n._handleTileLoad,n)(i,o)},!0)},_handleTileLoad:function(t,e){},_onClick:function(t){this.fire("click",this._objectForEvent(t))},_move:function(t){if(null!=t.latlng){var e=this._objectForEvent(t);e._tileCharCode!==this._tileCharCode?(this._mouseOn&&(this.fire("mouseout",{latlng:t.latlng,data:this._mouseOn,_tile:this._mouseOnTile,_tileCharCode:this._tileCharCode}),this._updateCursor("")),e.data&&(this.fire("mouseover",e),this._updateCursor("pointer")),this._mouseOn=e.data,this._mouseOnTile=e._tile,this._tileCharCode=e._tileCharCode):e.data&&this.fire("mousemove",e)}},_objectForEvent:function(t){var e=this._map,i=e.project(t.latlng),n=this.options.tileSize,o=this.options.resolution,s=Math.floor(i.x/n),l=Math.floor(i.y/n),a=Math.floor((i.x-s*n)/o),r=Math.floor((i.y-l*n)/o),h=e.options.crs.scale(e.getZoom())/n;s=(s+h)%h,l=(l+h)%h;var d=this._tileCoordsToKey({z:e.getZoom(),x:s,y:l}),u=this._cache[d];if(!u)return{latlng:t.latlng,data:null,_tile:null,_tileCharCode:null};var c=u.grid[r].charCodeAt(a),_=this._utfDecode(c),f=u.keys[_],p=u.data[f];return u.data.hasOwnProperty(f)||(p=null),{latlng:t.latlng,data:p,id:p?p.id:null,_tile:d,_tileCharCode:d+":"+c}},_dataForCharCode:function(t,e){var i=this._cache[t],n=this._utfDecode(e),o=i.keys[n],s=i.data[o];return i.data.hasOwnProperty(o)||(s=null),s},_utfDecode:function(t){return t>=93&&t--,t>=35&&t--,t-32},_utfEncode:function(t){var e=t+32;return e>=34&&e++,e>=92&&e++,e}}),L.utfGrid=function(t,e){return new L.UTFGrid(t,e)},L.UTFGridCanvas=L.UTFGrid.extend({options:{idField:"ID",buildIndex:!0,fillColor:"black",debug:!1},_adjacentTiles:null,onAdd:function(t){this._adjacentTiles=[],L.UTFGrid.prototype.onAdd.call(this,t)},createTile:function(t){this._loadTile(t);var e=document.createElement("canvas");return e.width=e.height=this.options.tileSize,this.options.debug&&this._drawDefaultTile(e.getContext("2d"),this._tileCoordsToKey(t)),e},_connectMapEventHandlers:function(){L.UTFGrid.prototype._connectMapEventHandlers.call(this),this.on("mouseover",this._handleMouseOver,this),this.on("mouseout",this._handleMouseOut,this)},_disconnectMapEventHandlers:function(){L.UTFGrid.prototype._disconnectMapEventHandlers.call(this),this.off("mouseover",this._handleMouseOver,this),this.off("mouseout",this._handleMouseOut,this)},_handleMouseOver:function(t){if(null!=t._tile&&null!=t._tileCharCode){this._clearAdjacentTiles();var e=t._tile;if(this._drawTile(e,parseInt(t._tileCharCode.split(":")[3])),t.data&&this._idIndex){var i=t.data[this.options.idField],n=e.split(":")[2];if(!(i&&this._idIndex[i]&&this._idIndex[i][n]))return;var o=this._idIndex[i][n];for(var s in o)s!==e&&(this._drawTile(s,o[s]),this._adjacentTiles.push(s))}}},_handleMouseOut:function(t){this._resetTile(t._tile),this._clearAdjacentTiles()},_clearAdjacentTiles:function(){if(this._adjacentTiles){for(var t=0;t<this._adjacentTiles.length;t++)this._resetTile(this._adjacentTiles[t]);this._adjacentTiles=[]}},_handleTileLoad:function(t,e){if(this.options.buildIndex)for(var i,n,o,s=this.options.idField,l=t.split(":")[2],a=0;a<e.keys.length;a++)n=e.data[e.keys[a]],n&&(i=n[s],i&&(null==this._idIndex[i]&&(this._idIndex[i]={}),o=this._idIndex[i],null==o[l]&&(o[l]={}),o[l][t]=this._utfEncode(a)))},_drawTile:function(t,e){if(null!=this._tiles[t]){var i=this._tiles[t].el,n=i.getContext("2d");this._resetTile(t);var o=this._cache[t].grid;n.fillStyle=this.options.fillColor;for(var s=this.options.tileSize/this.options.resolution,l=0;l<s;l++)for(var a=0;a<s;a++)if(o[a].charCodeAt(l)===e){for(var r=1;a<63&&o[a+1].charCodeAt(l)===e;)a++,r++;n.fillRect(4*l,4*a-4*(r-1),4,4*r)}}},_resetTile:function(t){if(null!=this._tiles[t]){var e=this._tiles[t].el;e.width=this.options.tileSize,this.options.debug&&this._drawDefaultTile(e.getContext("2d"),t)}},_drawDefaultTile:function(t,e){t.fillStyle="black",t.fillText(e,20,20),t.strokeStyle="red",t.beginPath(),t.moveTo(0,0),t.lineTo(255,0),t.lineTo(255,255),t.lineTo(0,255),t.closePath(),t.stroke()}}),L.utfGridCanvas=function(t,e){return new L.UTFGridCanvas(t,e)};