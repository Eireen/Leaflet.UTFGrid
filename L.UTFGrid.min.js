function corslite(url,callback,cors){var sent=false;if(typeof window.XMLHttpRequest==="undefined"){return callback(Error("Browser not supported"))}if(typeof cors==="undefined"){var m=url.match(/^\s*https?:\/\/[^\/]*/);cors=m&&m[0]!==location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")}var x=new window.XMLHttpRequest;function isSuccessful(status){return status>=200&&status<300||status===304}if(cors&&!("withCredentials"in x)){x=new window.XDomainRequest;var original=callback;callback=function(){if(sent){original.apply(this,arguments)}else{var that=this,args=arguments;setTimeout(function(){original.apply(that,args)},0)}}}function loaded(){if(x.status===undefined||isSuccessful(x.status))callback.call(x,null,x);else callback.call(x,x,null)}if("onload"in x){x.onload=loaded}else{x.onreadystatechange=function readystate(){if(x.readyState===4){loaded()}}}x.onerror=function error(evt){callback.call(this,evt||true,null);callback=function(){}};x.onprogress=function(){};x.ontimeout=function(evt){callback.call(this,evt,null);callback=function(){}};x.onabort=function(evt){callback.call(this,evt,null);callback=function(){}};x.open("GET",url,true);x.send(null);sent=true;return x}if(typeof module!=="undefined")module.exports=corslite;L.UTFGrid=L.TileLayer.extend({options:{resolution:4,pointerCursor:true,mouseInterval:66},_mouseOn:null,_mouseOnTile:null,_tileCharCode:null,_cache:null,_idIndex:null,_throttleMove:null,_updateCursor:function(){},onAdd:function(map){this._cache={};this._idIndex={};L.TileLayer.prototype.onAdd.call(this,map);this._throttleMove=L.Util.throttle(this._move,this.options.mouseInterval,this);if(this.options.pointerCursor){this._updateCursor=function(cursor){this._container.style.cursor=cursor}}map.on("boxzoomstart",this._disconnectMapEventHandlers,this);map.on("boxzoomend",this._throttleConnectEventHandlers,this);this._connectMapEventHandlers()},onRemove:function(){var map=this._map;map.off("boxzoomstart",this._disconnectMapEventHandlers,this);map.off("boxzoomend",this._throttleConnectEventHandlers,this);this._disconnectMapEventHandlers();this._updateCursor("");L.TileLayer.prototype.onRemove.call(this,map)},createTile:function(coords){this._loadTile(coords);return document.createElement("div")},_connectMapEventHandlers:function(){this._map.on("click",this._onClick,this);this._map.on("mousemove",this._throttleMove,this)},_disconnectMapEventHandlers:function(){this._map.off("click",this._onClick,this);this._map.off("mousemove",this._throttleMove,this)},_throttleConnectEventHandlers:function(){setTimeout(this._connectMapEventHandlers.bind(this),100)},_update:function(center,zoom){L.TileLayer.prototype._update.call(this,center,zoom)},_loadTile:function(coords){var url=this.getTileUrl(coords);var key=this._tileCoordsToKey(coords);var self=this;if(this._cache[key]){return}corslite(url,function(err,response){if(err){self.fire("error",{error:err});return}var data=JSON.parse(response.responseText);self._cache[key]=data;L.Util.bind(self._handleTileLoad,self)(key,data)},true)},_handleTileLoad:function(key,data){},_onClick:function(e){this.fire("click",this._objectForEvent(e))},_move:function(e){if(e.latlng==null){return}var on=this._objectForEvent(e);if(on._tileCharCode!==this._tileCharCode){if(this._mouseOn){this.fire("mouseout",{latlng:e.latlng,data:this._mouseOn,_tile:this._mouseOnTile,_tileCharCode:this._tileCharCode});this._updateCursor("")}if(on.data){this.fire("mouseover",on);this._updateCursor("pointer")}this._mouseOn=on.data;this._mouseOnTile=on._tile;this._tileCharCode=on._tileCharCode}else if(on.data){this.fire("mousemove",on)}},_objectForEvent:function(e){var map=this._map,point=map.project(e.latlng),tileSize=this.options.tileSize,resolution=this.options.resolution,x=Math.floor(point.x/tileSize),y=Math.floor(point.y/tileSize),gridX=Math.floor((point.x-x*tileSize)/resolution),gridY=Math.floor((point.y-y*tileSize)/resolution),max=map.options.crs.scale(map.getZoom())/tileSize;x=(x+max)%max;y=(y+max)%max;var tileKey=this._tileCoordsToKey({z:map.getZoom(),x:x,y:y});var data=this._cache[tileKey];if(!data){return{latlng:e.latlng,data:null,_tile:null,_tileCharCode:null}}var charCode=data.grid[gridY].charCodeAt(gridX);var idx=this._utfDecode(charCode),key=data.keys[idx],result=data.data[key];if(!data.data.hasOwnProperty(key)){result=null}return{latlng:e.latlng,data:result,id:result?result.id:null,_tile:tileKey,_tileCharCode:tileKey+":"+charCode}},_dataForCharCode:function(tileKey,charCode){var data=this._cache[tileKey];var idx=this._utfDecode(charCode),key=data.keys[idx],result=data.data[key];if(!data.data.hasOwnProperty(key)){result=null}return result},_utfDecode:function(c){if(c>=93){c--}if(c>=35){c--}return c-32},_utfEncode:function(c){var charCode=c+32;if(charCode>=34){charCode++}if(charCode>=92){charCode++}return charCode}});L.utfGrid=function(url,options){return new L.UTFGrid(url,options)};L.UTFGridCanvas=L.UTFGrid.extend({options:{idField:"ID",buildIndex:true,fillColor:"black",debug:false},_adjacentTiles:null,onAdd:function(map){this._adjacentTiles=[];L.UTFGrid.prototype.onAdd.call(this,map)},createTile:function(coords){this._loadTile(coords);var tile=document.createElement("canvas");tile.width=tile.height=this.options.tileSize;if(this.options.debug){this._drawDefaultTile(tile.getContext("2d"),this._tileCoordsToKey(coords))}return tile},_connectMapEventHandlers:function(){L.UTFGrid.prototype._connectMapEventHandlers.call(this);this.on("mouseover",this._handleMouseOver,this);this.on("mouseout",this._handleMouseOut,this)},_disconnectMapEventHandlers:function(){L.UTFGrid.prototype._disconnectMapEventHandlers.call(this);this.off("mouseover",this._handleMouseOver,this);this.off("mouseout",this._handleMouseOut,this)},_handleMouseOver:function(e){if(e._tile==null||e._tileCharCode==null){return}this._clearAdjacentTiles();var curTile=e._tile;this._drawTile(curTile,parseInt(e._tileCharCode.split(":")[3]));if(e.data&&this._idIndex){var id=e.data[this.options.idField];var zoomLevel=curTile.split(":")[2];if(!(id&&this._idIndex[id]&&this._idIndex[id][zoomLevel])){return}var idx=this._idIndex[id][zoomLevel];for(var tileKey in idx){if(tileKey!==curTile){this._drawTile(tileKey,idx[tileKey]);this._adjacentTiles.push(tileKey)}}}},_handleMouseOut:function(e){this._resetTile(e._tile);this._clearAdjacentTiles()},_clearAdjacentTiles:function(){if(this._adjacentTiles){for(var i=0;i<this._adjacentTiles.length;i++){this._resetTile(this._adjacentTiles[i])}this._adjacentTiles=[]}},_handleTileLoad:function(tileKey,data){if(this.options.buildIndex){var id,props,idx;var idField=this.options.idField;var zoomLevel=tileKey.split(":")[2];for(var i=0;i<data.keys.length;i++){props=data.data[data.keys[i]];if(props){id=props[idField];if(id){if(this._idIndex[id]==null){this._idIndex[id]={}}idx=this._idIndex[id];if(idx[zoomLevel]==null){idx[zoomLevel]={}}idx[zoomLevel][tileKey]=this._utfEncode(i)}}}}},_drawTile:function(tileKey,charCode){if(this._tiles[tileKey]==null){return}var canvas=this._tiles[tileKey].el;var ctx=canvas.getContext("2d");this._resetTile(tileKey);var grid=this._cache[tileKey].grid;ctx.fillStyle=this.options.fillColor;var dim=this.options.tileSize/this.options.resolution;for(var x=0;x<dim;x++){for(var y=0;y<dim;y++){if(grid[y].charCodeAt(x)===charCode){var sweep=1;while(y<63&&grid[y+1].charCodeAt(x)===charCode){y++;sweep++}ctx.fillRect(x*4,y*4-(sweep-1)*4,4,4*sweep)}}}},_resetTile:function(tileKey){if(this._tiles[tileKey]==null){return}var tile=this._tiles[tileKey].el;tile.width=this.options.tileSize;if(this.options.debug){this._drawDefaultTile(tile.getContext("2d"),tileKey)}},_drawDefaultTile:function(ctx,tileKey){ctx.fillStyle="black";ctx.fillText(tileKey,20,20);ctx.strokeStyle="red";ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(255,0);ctx.lineTo(255,255);ctx.lineTo(0,255);ctx.closePath();ctx.stroke()}});L.utfGridCanvas=function(url,options){return new L.UTFGridCanvas(url,options)};